const mesureWidth = item => {
  let reqItemWidth = 0;

  const screenWidth = $(window).width();
  const container = item.closest(".recipes");
  const titlesBlocks = container.find(".recipes__title");
  const titlesWidth = titlesBlocks.width() * titlesBlocks.length;

  const textContainer = item.find(".recipes__container");
  const paddingLeft = parseInt(textContainer.css("padding-left"));
  const paddingRight = parseInt(textContainer.css("padding-right"));

  const isMobile = window.matchMedia("(max-width: 768px)").matches;

  if (isMobile) {
    reqItemWidth = screenWidth - titlesWidth;
  } else {
    reqItemWidth = 500;
  }

  return {
    container: reqItemWidth,
    textContainer: reqItemWidth - paddingLeft - paddingRight
  }
};

const closeEveryItemInContainer = (container) => {
  const items = container.find(".recipes__item");
  const content = container.find(".recipes__description");

  items.removeClass("active"); 
  content.width(0);
};

const openItemAccord = (item) => {
  const hiddenContent = item.find(".recipes__description");
  const reqWidth = mesureWidth(item);
  const textBlock = item.find(".recipes__container");

  item.addClass("active");
  hiddenContent.width(reqWidth.container);
  textBlock.width(reqWidth.textContainer);
};

$(".recipes__title").on("click", (e) => {
   e.preventDefault();

   const $this = $(e.currentTarget);
   const item = $this.closest(".recipes__item");
   const itemOpened = item.hasClass("active");
   const container = $this.closest(".recipes");

   if (itemOpened) {
    closeEveryItemInContainer(container)
  } else {
    closeEveryItemInContainer(container)
    openItemAccord(item);
   }

});

$(".recipes__close").on("click", e => {
  e.preventDefault();

  closeEveryItemInContainer($('.recipes'));
});
const openItem = item => {
  const container = item.closest(".team__member");
  const contentBlock = container.find(".member__content");
  const textBlock = contentBlock.find(".member__content-block");
  const reqHeight = textBlock.height();
  
  container.addClass("active")
  contentBlock.height(reqHeight);
}

const closeEveryItem = container => {
  const items = container.find('.member__content');
  const itemContainer = container.find(".team__member");

  itemContainer.removeClass("active");
  items.height(0);
}

$('.member__name').click(e => {
  const $this = $(e.currentTarget);
  const container = $this.closest('.team');
  const elemContainer = $this.closest(".team__member");

  if (elemContainer.hasClass("active")) {
    closeEveryItem(container);
  } else {
    closeEveryItem(container);
    openItem($this);
  }

})



// $(document).ready(() => {
//   $('.member__name').on('click', function(e) {
//     let member = $(e.currentTarget).next();
//     $(this).toggleClass('member__function--active');
//     member.slideToggle();
//   })
// });
const htmlElem = $("html");
if ($(window).width() < 400) {
  htmlElem.css("font-size", "3.7vmin");
}
$(window).resize(function(){
  if ($(window).width() < 400) {
    htmlElem.css("font-size", "3.7vmin");
  } else {
    htmlElem.css("font-size", "");
  }
});
let myMap;

const init = () => {
  myMap = new ymaps.Map("map", {
    center: [55.753969, 37.606673],
    zoom: 14,
    controls: []
  });

  const coords =  [
    [55.763183, 37.582547],
    [55.741035, 37.573998],
    [55.746456, 37.608084],
    [55.761756, 37.618330]
  ];

  const myCollection = new ymaps.GeoObjectCollection({}, {
    draggable: false,
    iconLayout: 'default#image',
    iconImageHref: "./img/marker.svg",
    iconImageSize: [46, 57],
    iconImageOffset: [-35, -52]
  });

  coords.forEach(coord => {
    myCollection.add(new ymaps.Placemark(coord));
  });

  myMap.geoObjects.add(myCollection);

  myMap.behaviors.disable('scrollZoom');
}

ymaps.ready(init); 
const menu = document.querySelector(".menu");
const hamburger = document.querySelector(".hamburger");

hamburger.addEventListener("click", e => {
  e.preventDefault();

  menu.classList.add("menu--mobile");
  hamburger.classList.add("hamburger--close");

  hamburger.addEventListener("click", i => {
    menu.classList.toggle("menu--mobile");
    hamburger.classList.toggle("hamburger--close");
  })

})


// const menu = document.querySelector(".menu");
// const hamburger = document.querySelector(".hamburger");

// hamburger.addEventListener("click", e => {
//   e.preventDefault();
//   menu.classList.add("menu--mobile");

//   const closeElement = document.createElement("div");
//   closeElement.classList.add("close");
//   closeElement.innerHTML = "x";

//   closeElement.addEventListener("click", e => {
//     menu.classList.remove("menu--mobile");
//     menu.removeChild(closeElement);
//   })

//   menu.appendChild(closeElement);
// })
const validateFields = (form, fieldsArray) => {
  fieldsArray.forEach(field => {
    field.removeClass("input-eror");
    if (field.val().trim() === "") {
      field.addClass("input-eror"); 
    }
  });

  const errorFields = form.find(".input-eror");

  return errorFields.length === 0;
}

$('.form').submit(e => {
  e.preventDefault();

  const form = $(e.currentTarget);
  const name = form.find("[name='name']");
  const phone = form.find("[name='phone']");
  const comment = form.find("[name='comment']");
  const to = form.find("[name='to']");

  const modal = $("#modal");
  const content = modal.find(".modal__content");

  modal.removeClass("error-modal");

  const isValid = validateFields(form, [name, phone, comment, to]);

  if (isValid) {
    const request = $.ajax({
      url: "https://webdev-api.loftschool.com/sendmail",
      method: "post",
      data: {
      name: name.val(),
      phone: phone.val(),
      comment: comment.val(),
      to: to.val(),
      }
    });

    request.done(data => {
      content.text(data.message);
    });

    request.fail( data => {
      const message = data.responseJSON.message;
      content.text(message);
      modal.addClass("error-modal");
    });

    request.always(() => {
      $.fancybox.open({
        src  : '#modal',
        type : 'inline'
        });     
    })
  }
});

$('.app-close-modal').click(e => {
  e.preventDefault();

  $.fancybox.close();
})
const sections = $("section");
const display = $(".maincontent");
const sideMenu = $(".fixed-menu");
const menuItems = sideMenu.find(".fixed-menu__item");

const mobileDetect = new MobileDetect(window.navigator.userAgent);
const isMobile = mobileDetect.mobile();

let inScroll = false;

sections.first().addClass("active");

const countSectionPosition = (sectionEq) => {
  const position = sectionEq * -100;

  if (isNaN(position)) {
    console.error("передано не верное значение в countSectionPosition");
    return 0;
  }

  return position;
};

const chageMenuThemeForSection = (sectionEq) => {
  const currentSection = sections.eq(sectionEq);
  const menuTheme = currentSection.attr("data-sidemenu-theme");
  const activeClass = "fixed-menu--shadowed";

  if (menuTheme == "black") {
    sideMenu.addClass(activeClass);
  } else {
    sideMenu.removeClass(activeClass);
  }
};

const resetActiveClassForItem = (items, itemEq, activeClass) => {
  items.eq(itemEq).addClass(activeClass).siblings().removeClass(activeClass);
};

const performTransition = (sectionEq) => {
  if(inScroll) return;

  const transitionOver = 1000;
  const mouseInertiaOver = 300;

  inScroll = true;

  const position = countSectionPosition(sectionEq);

  chageMenuThemeForSection(sectionEq);

  display.css({
    transform: `translateY(${position}%)`,
  });

  resetActiveClassForItem(sections, sectionEq, "active");

  setTimeout(() => {
    inScroll = false;
    resetActiveClassForItem(menuItems, sectionEq, "fixed-menu__item--active");
  }, transitionOver + mouseInertiaOver);
};

const viewportScroller = () => {
  const activeSection = sections.filter(".active");
  const nextSection = activeSection.next();
  const prevSection = activeSection.prev();

  return {
    next() {
      if (nextSection.length) {
        performTransition(nextSection.index());
      }
    },
    prev() {
      if (prevSection.length) {
        performTransition(prevSection.index());
      }
    },
  };
};

$(window).on("wheel", (e) => {
  const deltaY = e.originalEvent.deltaY;
  const scroller = viewportScroller();

  if (deltaY > 0) {
    scroller.next();
  }
  
  if (deltaY < 0 ) {
    scroller.prev();
  }
 });

 $(window).on("keydown", (e) => {
  const tagName = e.target.tagName.toLowerCase();
  const userTypingInInputs = tagName == "input" || tagName == "textarea";
  const scroller = viewportScroller();

  if (userTypingInInputs) return;

  switch (e.keyCode) {
    case 38:
        scroller.prev();
      break;
      
    case 40:
        scroller.next();
        break;
    }
 });

 $(".wrapper").on("touchmove", (e) => e.preventDefault());

 $("[data-scroll-to]").click((e) => {
   e.preventDefault();

  const $this = $(e.currentTarget);
  const target = $this.attr("data-scroll-to");
  const reqSection = $(`[data-section-id=${target}]`);
  
  performTransition(reqSection.index());
 });

if (isMobile) {
  //  https://github.com/mattbryson/TouchSwipe-Jquery-Plugin
  $("body").swipe({
    swipe: function (event, direction) {
      const scroller = viewportScroller();
      let scrollDirection = "";

      if (direction == "up") scrollDirection = "next";
      if (direction == "down") scrollDirection = "prev";

      scroller[scrollDirection]();
    },
  });
}
const slider = $('.sliders__list').bxSlider({
  pager: false,
  controls: false
});

$('.sliders__arrow--left').click(e => {
  e.preventDefault();
  slider.goToPrevSlide();
})
$('.sliders__arrow--right').click(e => {
  e.preventDefault();
  slider.goToNextSlide();
})
const findBlockByAlias = alias => {
  return $('.reviews__content').filter((ndx, item) => {
    return $(item).attr("data-linked-with") == alias
  });
};

$('.interactive-avatar__link').click(e => {
  e.preventDefault();

  const $this = $(e.currentTarget);
  const target = $this.attr("data-open");
  const itemToShow = findBlockByAlias(target);
  const curItem = $this.closest(".interactive-avatar");

  itemToShow.addClass("active").siblings().removeClass("active");
  curItem.addClass("active").siblings().removeClass("active");
})
let video;
let durationControl;
let soundControl;
let intervalId;

document.addEventListener('DOMContentLoaded', e=>{
    video = document.getElementById('video');

    video.addEventListener('click', playStop);

    let playButtons = document.querySelectorAll('.play');
    for (let i = 0; i < playButtons.length; i++) {
        playButtons[i].addEventListener('click', playStop);
    }

    let micControl = document.getElementById('micLevel');
    micControl.addEventListener('click' , soundOf);

    durationControl = document.getElementById('durationLevel');
    durationControl.addEventListener('mousedown' , stopInterval);
    durationControl.addEventListener('click', setVideoDuration);

    durationControl.min = 0;
    durationControl.value = 0;

    soundControl = document.getElementById('volumeLevel');
    soundControl.addEventListener('click' , changeSoundVolume);
    soundControl.addEventListener('mouseup' , changeSoundVolume);

    soundControl.min = 0;
    soundControl.max = 10;

    soundControl.value = soundControl.max;

})

function playStop(){
    let playImg = document.querySelector('.video__play');
    playImg.classList.toggle('video__play--active');

    durationControl.max = video.duration;

    if(video.paused){
        video.play();
        intervalId = setInterval(updateDuration , 1000 /66);
    }else{ 
        video.pause();
        clearInterval(intervalId);
    }
}

function updateDuration(){
    durationControl.value = video.currentTime;
}

function stopInterval(){
    video.pause();
    clearInterval(intervalId);
}

function setVideoDuration(){
    if(video.paused){
        video.play();
    }else{
        video.pause();
    }

    video.currentTime = durationControl.value;
    intervalId = setInterval(updateDuration , 1000 /66);
}

function changeSoundVolume(){
    video.volume = soundControl.value/10;
}

function soundOf(){
    if(video.volume === 0){
        video.volume = soundLevel;
        soundControl.value = soundLevel * 10;
    }else{
        soundLevel = video.volume;
        video.volume = 0;
        soundControl.value = 0;
    }
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFjY29yZC1tZW51LmpzIiwiYWNjb3JkaW9uLmpzIiwiaGVpZ2h0LmpzIiwibWFwLmpzIiwibWVudS5qcyIsIm1vZGFsLmpzIiwib3BzLmpzIiwic2xpZGVyLmpzIiwidGFicy5qcyIsInZpZGVvLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2pFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDeENBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNWQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2pDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDbENBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNoRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUMxSUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNaQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDaEJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoibWFpbi5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBtZXN1cmVXaWR0aCA9IGl0ZW0gPT4ge1xuICBsZXQgcmVxSXRlbVdpZHRoID0gMDtcblxuICBjb25zdCBzY3JlZW5XaWR0aCA9ICQod2luZG93KS53aWR0aCgpO1xuICBjb25zdCBjb250YWluZXIgPSBpdGVtLmNsb3Nlc3QoXCIucmVjaXBlc1wiKTtcbiAgY29uc3QgdGl0bGVzQmxvY2tzID0gY29udGFpbmVyLmZpbmQoXCIucmVjaXBlc19fdGl0bGVcIik7XG4gIGNvbnN0IHRpdGxlc1dpZHRoID0gdGl0bGVzQmxvY2tzLndpZHRoKCkgKiB0aXRsZXNCbG9ja3MubGVuZ3RoO1xuXG4gIGNvbnN0IHRleHRDb250YWluZXIgPSBpdGVtLmZpbmQoXCIucmVjaXBlc19fY29udGFpbmVyXCIpO1xuICBjb25zdCBwYWRkaW5nTGVmdCA9IHBhcnNlSW50KHRleHRDb250YWluZXIuY3NzKFwicGFkZGluZy1sZWZ0XCIpKTtcbiAgY29uc3QgcGFkZGluZ1JpZ2h0ID0gcGFyc2VJbnQodGV4dENvbnRhaW5lci5jc3MoXCJwYWRkaW5nLXJpZ2h0XCIpKTtcblxuICBjb25zdCBpc01vYmlsZSA9IHdpbmRvdy5tYXRjaE1lZGlhKFwiKG1heC13aWR0aDogNzY4cHgpXCIpLm1hdGNoZXM7XG5cbiAgaWYgKGlzTW9iaWxlKSB7XG4gICAgcmVxSXRlbVdpZHRoID0gc2NyZWVuV2lkdGggLSB0aXRsZXNXaWR0aDtcbiAgfSBlbHNlIHtcbiAgICByZXFJdGVtV2lkdGggPSA1MDA7XG4gIH1cblxuICByZXR1cm4ge1xuICAgIGNvbnRhaW5lcjogcmVxSXRlbVdpZHRoLFxuICAgIHRleHRDb250YWluZXI6IHJlcUl0ZW1XaWR0aCAtIHBhZGRpbmdMZWZ0IC0gcGFkZGluZ1JpZ2h0XG4gIH1cbn07XG5cbmNvbnN0IGNsb3NlRXZlcnlJdGVtSW5Db250YWluZXIgPSAoY29udGFpbmVyKSA9PiB7XG4gIGNvbnN0IGl0ZW1zID0gY29udGFpbmVyLmZpbmQoXCIucmVjaXBlc19faXRlbVwiKTtcbiAgY29uc3QgY29udGVudCA9IGNvbnRhaW5lci5maW5kKFwiLnJlY2lwZXNfX2Rlc2NyaXB0aW9uXCIpO1xuXG4gIGl0ZW1zLnJlbW92ZUNsYXNzKFwiYWN0aXZlXCIpOyBcbiAgY29udGVudC53aWR0aCgwKTtcbn07XG5cbmNvbnN0IG9wZW5JdGVtQWNjb3JkID0gKGl0ZW0pID0+IHtcbiAgY29uc3QgaGlkZGVuQ29udGVudCA9IGl0ZW0uZmluZChcIi5yZWNpcGVzX19kZXNjcmlwdGlvblwiKTtcbiAgY29uc3QgcmVxV2lkdGggPSBtZXN1cmVXaWR0aChpdGVtKTtcbiAgY29uc3QgdGV4dEJsb2NrID0gaXRlbS5maW5kKFwiLnJlY2lwZXNfX2NvbnRhaW5lclwiKTtcblxuICBpdGVtLmFkZENsYXNzKFwiYWN0aXZlXCIpO1xuICBoaWRkZW5Db250ZW50LndpZHRoKHJlcVdpZHRoLmNvbnRhaW5lcik7XG4gIHRleHRCbG9jay53aWR0aChyZXFXaWR0aC50ZXh0Q29udGFpbmVyKTtcbn07XG5cbiQoXCIucmVjaXBlc19fdGl0bGVcIikub24oXCJjbGlja1wiLCAoZSkgPT4ge1xuICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICBjb25zdCAkdGhpcyA9ICQoZS5jdXJyZW50VGFyZ2V0KTtcbiAgIGNvbnN0IGl0ZW0gPSAkdGhpcy5jbG9zZXN0KFwiLnJlY2lwZXNfX2l0ZW1cIik7XG4gICBjb25zdCBpdGVtT3BlbmVkID0gaXRlbS5oYXNDbGFzcyhcImFjdGl2ZVwiKTtcbiAgIGNvbnN0IGNvbnRhaW5lciA9ICR0aGlzLmNsb3Nlc3QoXCIucmVjaXBlc1wiKTtcblxuICAgaWYgKGl0ZW1PcGVuZWQpIHtcbiAgICBjbG9zZUV2ZXJ5SXRlbUluQ29udGFpbmVyKGNvbnRhaW5lcilcbiAgfSBlbHNlIHtcbiAgICBjbG9zZUV2ZXJ5SXRlbUluQ29udGFpbmVyKGNvbnRhaW5lcilcbiAgICBvcGVuSXRlbUFjY29yZChpdGVtKTtcbiAgIH1cblxufSk7XG5cbiQoXCIucmVjaXBlc19fY2xvc2VcIikub24oXCJjbGlja1wiLCBlID0+IHtcbiAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gIGNsb3NlRXZlcnlJdGVtSW5Db250YWluZXIoJCgnLnJlY2lwZXMnKSk7XG59KTsiLCJjb25zdCBvcGVuSXRlbSA9IGl0ZW0gPT4ge1xuICBjb25zdCBjb250YWluZXIgPSBpdGVtLmNsb3Nlc3QoXCIudGVhbV9fbWVtYmVyXCIpO1xuICBjb25zdCBjb250ZW50QmxvY2sgPSBjb250YWluZXIuZmluZChcIi5tZW1iZXJfX2NvbnRlbnRcIik7XG4gIGNvbnN0IHRleHRCbG9jayA9IGNvbnRlbnRCbG9jay5maW5kKFwiLm1lbWJlcl9fY29udGVudC1ibG9ja1wiKTtcbiAgY29uc3QgcmVxSGVpZ2h0ID0gdGV4dEJsb2NrLmhlaWdodCgpO1xuICBcbiAgY29udGFpbmVyLmFkZENsYXNzKFwiYWN0aXZlXCIpXG4gIGNvbnRlbnRCbG9jay5oZWlnaHQocmVxSGVpZ2h0KTtcbn1cblxuY29uc3QgY2xvc2VFdmVyeUl0ZW0gPSBjb250YWluZXIgPT4ge1xuICBjb25zdCBpdGVtcyA9IGNvbnRhaW5lci5maW5kKCcubWVtYmVyX19jb250ZW50Jyk7XG4gIGNvbnN0IGl0ZW1Db250YWluZXIgPSBjb250YWluZXIuZmluZChcIi50ZWFtX19tZW1iZXJcIik7XG5cbiAgaXRlbUNvbnRhaW5lci5yZW1vdmVDbGFzcyhcImFjdGl2ZVwiKTtcbiAgaXRlbXMuaGVpZ2h0KDApO1xufVxuXG4kKCcubWVtYmVyX19uYW1lJykuY2xpY2soZSA9PiB7XG4gIGNvbnN0ICR0aGlzID0gJChlLmN1cnJlbnRUYXJnZXQpO1xuICBjb25zdCBjb250YWluZXIgPSAkdGhpcy5jbG9zZXN0KCcudGVhbScpO1xuICBjb25zdCBlbGVtQ29udGFpbmVyID0gJHRoaXMuY2xvc2VzdChcIi50ZWFtX19tZW1iZXJcIik7XG5cbiAgaWYgKGVsZW1Db250YWluZXIuaGFzQ2xhc3MoXCJhY3RpdmVcIikpIHtcbiAgICBjbG9zZUV2ZXJ5SXRlbShjb250YWluZXIpO1xuICB9IGVsc2Uge1xuICAgIGNsb3NlRXZlcnlJdGVtKGNvbnRhaW5lcik7XG4gICAgb3Blbkl0ZW0oJHRoaXMpO1xuICB9XG5cbn0pXG5cblxuXG4vLyAkKGRvY3VtZW50KS5yZWFkeSgoKSA9PiB7XG4vLyAgICQoJy5tZW1iZXJfX25hbWUnKS5vbignY2xpY2snLCBmdW5jdGlvbihlKSB7XG4vLyAgICAgbGV0IG1lbWJlciA9ICQoZS5jdXJyZW50VGFyZ2V0KS5uZXh0KCk7XG4vLyAgICAgJCh0aGlzKS50b2dnbGVDbGFzcygnbWVtYmVyX19mdW5jdGlvbi0tYWN0aXZlJyk7XG4vLyAgICAgbWVtYmVyLnNsaWRlVG9nZ2xlKCk7XG4vLyAgIH0pXG4vLyB9KTsiLCJjb25zdCBodG1sRWxlbSA9ICQoXCJodG1sXCIpO1xuaWYgKCQod2luZG93KS53aWR0aCgpIDwgNDAwKSB7XG4gIGh0bWxFbGVtLmNzcyhcImZvbnQtc2l6ZVwiLCBcIjMuN3ZtaW5cIik7XG59XG4kKHdpbmRvdykucmVzaXplKGZ1bmN0aW9uKCl7XG4gIGlmICgkKHdpbmRvdykud2lkdGgoKSA8IDQwMCkge1xuICAgIGh0bWxFbGVtLmNzcyhcImZvbnQtc2l6ZVwiLCBcIjMuN3ZtaW5cIik7XG4gIH0gZWxzZSB7XG4gICAgaHRtbEVsZW0uY3NzKFwiZm9udC1zaXplXCIsIFwiXCIpO1xuICB9XG59KTsiLCJsZXQgbXlNYXA7XG5cbmNvbnN0IGluaXQgPSAoKSA9PiB7XG4gIG15TWFwID0gbmV3IHltYXBzLk1hcChcIm1hcFwiLCB7XG4gICAgY2VudGVyOiBbNTUuNzUzOTY5LCAzNy42MDY2NzNdLFxuICAgIHpvb206IDE0LFxuICAgIGNvbnRyb2xzOiBbXVxuICB9KTtcblxuICBjb25zdCBjb29yZHMgPSAgW1xuICAgIFs1NS43NjMxODMsIDM3LjU4MjU0N10sXG4gICAgWzU1Ljc0MTAzNSwgMzcuNTczOTk4XSxcbiAgICBbNTUuNzQ2NDU2LCAzNy42MDgwODRdLFxuICAgIFs1NS43NjE3NTYsIDM3LjYxODMzMF1cbiAgXTtcblxuICBjb25zdCBteUNvbGxlY3Rpb24gPSBuZXcgeW1hcHMuR2VvT2JqZWN0Q29sbGVjdGlvbih7fSwge1xuICAgIGRyYWdnYWJsZTogZmFsc2UsXG4gICAgaWNvbkxheW91dDogJ2RlZmF1bHQjaW1hZ2UnLFxuICAgIGljb25JbWFnZUhyZWY6IFwiLi9pbWcvbWFya2VyLnN2Z1wiLFxuICAgIGljb25JbWFnZVNpemU6IFs0NiwgNTddLFxuICAgIGljb25JbWFnZU9mZnNldDogWy0zNSwgLTUyXVxuICB9KTtcblxuICBjb29yZHMuZm9yRWFjaChjb29yZCA9PiB7XG4gICAgbXlDb2xsZWN0aW9uLmFkZChuZXcgeW1hcHMuUGxhY2VtYXJrKGNvb3JkKSk7XG4gIH0pO1xuXG4gIG15TWFwLmdlb09iamVjdHMuYWRkKG15Q29sbGVjdGlvbik7XG5cbiAgbXlNYXAuYmVoYXZpb3JzLmRpc2FibGUoJ3Njcm9sbFpvb20nKTtcbn1cblxueW1hcHMucmVhZHkoaW5pdCk7ICIsImNvbnN0IG1lbnUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiLm1lbnVcIik7XG5jb25zdCBoYW1idXJnZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiLmhhbWJ1cmdlclwiKTtcblxuaGFtYnVyZ2VyLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCBlID0+IHtcbiAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gIG1lbnUuY2xhc3NMaXN0LmFkZChcIm1lbnUtLW1vYmlsZVwiKTtcbiAgaGFtYnVyZ2VyLmNsYXNzTGlzdC5hZGQoXCJoYW1idXJnZXItLWNsb3NlXCIpO1xuXG4gIGhhbWJ1cmdlci5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgaSA9PiB7XG4gICAgbWVudS5jbGFzc0xpc3QudG9nZ2xlKFwibWVudS0tbW9iaWxlXCIpO1xuICAgIGhhbWJ1cmdlci5jbGFzc0xpc3QudG9nZ2xlKFwiaGFtYnVyZ2VyLS1jbG9zZVwiKTtcbiAgfSlcblxufSlcblxuXG4vLyBjb25zdCBtZW51ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIi5tZW51XCIpO1xuLy8gY29uc3QgaGFtYnVyZ2VyID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIi5oYW1idXJnZXJcIik7XG5cbi8vIGhhbWJ1cmdlci5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgZSA9PiB7XG4vLyAgIGUucHJldmVudERlZmF1bHQoKTtcbi8vICAgbWVudS5jbGFzc0xpc3QuYWRkKFwibWVudS0tbW9iaWxlXCIpO1xuXG4vLyAgIGNvbnN0IGNsb3NlRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XG4vLyAgIGNsb3NlRWxlbWVudC5jbGFzc0xpc3QuYWRkKFwiY2xvc2VcIik7XG4vLyAgIGNsb3NlRWxlbWVudC5pbm5lckhUTUwgPSBcInhcIjtcblxuLy8gICBjbG9zZUVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIGUgPT4ge1xuLy8gICAgIG1lbnUuY2xhc3NMaXN0LnJlbW92ZShcIm1lbnUtLW1vYmlsZVwiKTtcbi8vICAgICBtZW51LnJlbW92ZUNoaWxkKGNsb3NlRWxlbWVudCk7XG4vLyAgIH0pXG5cbi8vICAgbWVudS5hcHBlbmRDaGlsZChjbG9zZUVsZW1lbnQpO1xuLy8gfSkiLCJjb25zdCB2YWxpZGF0ZUZpZWxkcyA9IChmb3JtLCBmaWVsZHNBcnJheSkgPT4ge1xuICBmaWVsZHNBcnJheS5mb3JFYWNoKGZpZWxkID0+IHtcbiAgICBmaWVsZC5yZW1vdmVDbGFzcyhcImlucHV0LWVyb3JcIik7XG4gICAgaWYgKGZpZWxkLnZhbCgpLnRyaW0oKSA9PT0gXCJcIikge1xuICAgICAgZmllbGQuYWRkQ2xhc3MoXCJpbnB1dC1lcm9yXCIpOyBcbiAgICB9XG4gIH0pO1xuXG4gIGNvbnN0IGVycm9yRmllbGRzID0gZm9ybS5maW5kKFwiLmlucHV0LWVyb3JcIik7XG5cbiAgcmV0dXJuIGVycm9yRmllbGRzLmxlbmd0aCA9PT0gMDtcbn1cblxuJCgnLmZvcm0nKS5zdWJtaXQoZSA9PiB7XG4gIGUucHJldmVudERlZmF1bHQoKTtcblxuICBjb25zdCBmb3JtID0gJChlLmN1cnJlbnRUYXJnZXQpO1xuICBjb25zdCBuYW1lID0gZm9ybS5maW5kKFwiW25hbWU9J25hbWUnXVwiKTtcbiAgY29uc3QgcGhvbmUgPSBmb3JtLmZpbmQoXCJbbmFtZT0ncGhvbmUnXVwiKTtcbiAgY29uc3QgY29tbWVudCA9IGZvcm0uZmluZChcIltuYW1lPSdjb21tZW50J11cIik7XG4gIGNvbnN0IHRvID0gZm9ybS5maW5kKFwiW25hbWU9J3RvJ11cIik7XG5cbiAgY29uc3QgbW9kYWwgPSAkKFwiI21vZGFsXCIpO1xuICBjb25zdCBjb250ZW50ID0gbW9kYWwuZmluZChcIi5tb2RhbF9fY29udGVudFwiKTtcblxuICBtb2RhbC5yZW1vdmVDbGFzcyhcImVycm9yLW1vZGFsXCIpO1xuXG4gIGNvbnN0IGlzVmFsaWQgPSB2YWxpZGF0ZUZpZWxkcyhmb3JtLCBbbmFtZSwgcGhvbmUsIGNvbW1lbnQsIHRvXSk7XG5cbiAgaWYgKGlzVmFsaWQpIHtcbiAgICBjb25zdCByZXF1ZXN0ID0gJC5hamF4KHtcbiAgICAgIHVybDogXCJodHRwczovL3dlYmRldi1hcGkubG9mdHNjaG9vbC5jb20vc2VuZG1haWxcIixcbiAgICAgIG1ldGhvZDogXCJwb3N0XCIsXG4gICAgICBkYXRhOiB7XG4gICAgICBuYW1lOiBuYW1lLnZhbCgpLFxuICAgICAgcGhvbmU6IHBob25lLnZhbCgpLFxuICAgICAgY29tbWVudDogY29tbWVudC52YWwoKSxcbiAgICAgIHRvOiB0by52YWwoKSxcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJlcXVlc3QuZG9uZShkYXRhID0+IHtcbiAgICAgIGNvbnRlbnQudGV4dChkYXRhLm1lc3NhZ2UpO1xuICAgIH0pO1xuXG4gICAgcmVxdWVzdC5mYWlsKCBkYXRhID0+IHtcbiAgICAgIGNvbnN0IG1lc3NhZ2UgPSBkYXRhLnJlc3BvbnNlSlNPTi5tZXNzYWdlO1xuICAgICAgY29udGVudC50ZXh0KG1lc3NhZ2UpO1xuICAgICAgbW9kYWwuYWRkQ2xhc3MoXCJlcnJvci1tb2RhbFwiKTtcbiAgICB9KTtcblxuICAgIHJlcXVlc3QuYWx3YXlzKCgpID0+IHtcbiAgICAgICQuZmFuY3lib3gub3Blbih7XG4gICAgICAgIHNyYyAgOiAnI21vZGFsJyxcbiAgICAgICAgdHlwZSA6ICdpbmxpbmUnXG4gICAgICAgIH0pOyAgICAgXG4gICAgfSlcbiAgfVxufSk7XG5cbiQoJy5hcHAtY2xvc2UtbW9kYWwnKS5jbGljayhlID0+IHtcbiAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICQuZmFuY3lib3guY2xvc2UoKTtcbn0pIiwiY29uc3Qgc2VjdGlvbnMgPSAkKFwic2VjdGlvblwiKTtcbmNvbnN0IGRpc3BsYXkgPSAkKFwiLm1haW5jb250ZW50XCIpO1xuY29uc3Qgc2lkZU1lbnUgPSAkKFwiLmZpeGVkLW1lbnVcIik7XG5jb25zdCBtZW51SXRlbXMgPSBzaWRlTWVudS5maW5kKFwiLmZpeGVkLW1lbnVfX2l0ZW1cIik7XG5cbmNvbnN0IG1vYmlsZURldGVjdCA9IG5ldyBNb2JpbGVEZXRlY3Qod2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQpO1xuY29uc3QgaXNNb2JpbGUgPSBtb2JpbGVEZXRlY3QubW9iaWxlKCk7XG5cbmxldCBpblNjcm9sbCA9IGZhbHNlO1xuXG5zZWN0aW9ucy5maXJzdCgpLmFkZENsYXNzKFwiYWN0aXZlXCIpO1xuXG5jb25zdCBjb3VudFNlY3Rpb25Qb3NpdGlvbiA9IChzZWN0aW9uRXEpID0+IHtcbiAgY29uc3QgcG9zaXRpb24gPSBzZWN0aW9uRXEgKiAtMTAwO1xuXG4gIGlmIChpc05hTihwb3NpdGlvbikpIHtcbiAgICBjb25zb2xlLmVycm9yKFwi0L/QtdGA0LXQtNCw0L3QviDQvdC1INCy0LXRgNC90L7QtSDQt9C90LDRh9C10L3QuNC1INCyIGNvdW50U2VjdGlvblBvc2l0aW9uXCIpO1xuICAgIHJldHVybiAwO1xuICB9XG5cbiAgcmV0dXJuIHBvc2l0aW9uO1xufTtcblxuY29uc3QgY2hhZ2VNZW51VGhlbWVGb3JTZWN0aW9uID0gKHNlY3Rpb25FcSkgPT4ge1xuICBjb25zdCBjdXJyZW50U2VjdGlvbiA9IHNlY3Rpb25zLmVxKHNlY3Rpb25FcSk7XG4gIGNvbnN0IG1lbnVUaGVtZSA9IGN1cnJlbnRTZWN0aW9uLmF0dHIoXCJkYXRhLXNpZGVtZW51LXRoZW1lXCIpO1xuICBjb25zdCBhY3RpdmVDbGFzcyA9IFwiZml4ZWQtbWVudS0tc2hhZG93ZWRcIjtcblxuICBpZiAobWVudVRoZW1lID09IFwiYmxhY2tcIikge1xuICAgIHNpZGVNZW51LmFkZENsYXNzKGFjdGl2ZUNsYXNzKTtcbiAgfSBlbHNlIHtcbiAgICBzaWRlTWVudS5yZW1vdmVDbGFzcyhhY3RpdmVDbGFzcyk7XG4gIH1cbn07XG5cbmNvbnN0IHJlc2V0QWN0aXZlQ2xhc3NGb3JJdGVtID0gKGl0ZW1zLCBpdGVtRXEsIGFjdGl2ZUNsYXNzKSA9PiB7XG4gIGl0ZW1zLmVxKGl0ZW1FcSkuYWRkQ2xhc3MoYWN0aXZlQ2xhc3MpLnNpYmxpbmdzKCkucmVtb3ZlQ2xhc3MoYWN0aXZlQ2xhc3MpO1xufTtcblxuY29uc3QgcGVyZm9ybVRyYW5zaXRpb24gPSAoc2VjdGlvbkVxKSA9PiB7XG4gIGlmKGluU2Nyb2xsKSByZXR1cm47XG5cbiAgY29uc3QgdHJhbnNpdGlvbk92ZXIgPSAxMDAwO1xuICBjb25zdCBtb3VzZUluZXJ0aWFPdmVyID0gMzAwO1xuXG4gIGluU2Nyb2xsID0gdHJ1ZTtcblxuICBjb25zdCBwb3NpdGlvbiA9IGNvdW50U2VjdGlvblBvc2l0aW9uKHNlY3Rpb25FcSk7XG5cbiAgY2hhZ2VNZW51VGhlbWVGb3JTZWN0aW9uKHNlY3Rpb25FcSk7XG5cbiAgZGlzcGxheS5jc3Moe1xuICAgIHRyYW5zZm9ybTogYHRyYW5zbGF0ZVkoJHtwb3NpdGlvbn0lKWAsXG4gIH0pO1xuXG4gIHJlc2V0QWN0aXZlQ2xhc3NGb3JJdGVtKHNlY3Rpb25zLCBzZWN0aW9uRXEsIFwiYWN0aXZlXCIpO1xuXG4gIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgIGluU2Nyb2xsID0gZmFsc2U7XG4gICAgcmVzZXRBY3RpdmVDbGFzc0Zvckl0ZW0obWVudUl0ZW1zLCBzZWN0aW9uRXEsIFwiZml4ZWQtbWVudV9faXRlbS0tYWN0aXZlXCIpO1xuICB9LCB0cmFuc2l0aW9uT3ZlciArIG1vdXNlSW5lcnRpYU92ZXIpO1xufTtcblxuY29uc3Qgdmlld3BvcnRTY3JvbGxlciA9ICgpID0+IHtcbiAgY29uc3QgYWN0aXZlU2VjdGlvbiA9IHNlY3Rpb25zLmZpbHRlcihcIi5hY3RpdmVcIik7XG4gIGNvbnN0IG5leHRTZWN0aW9uID0gYWN0aXZlU2VjdGlvbi5uZXh0KCk7XG4gIGNvbnN0IHByZXZTZWN0aW9uID0gYWN0aXZlU2VjdGlvbi5wcmV2KCk7XG5cbiAgcmV0dXJuIHtcbiAgICBuZXh0KCkge1xuICAgICAgaWYgKG5leHRTZWN0aW9uLmxlbmd0aCkge1xuICAgICAgICBwZXJmb3JtVHJhbnNpdGlvbihuZXh0U2VjdGlvbi5pbmRleCgpKTtcbiAgICAgIH1cbiAgICB9LFxuICAgIHByZXYoKSB7XG4gICAgICBpZiAocHJldlNlY3Rpb24ubGVuZ3RoKSB7XG4gICAgICAgIHBlcmZvcm1UcmFuc2l0aW9uKHByZXZTZWN0aW9uLmluZGV4KCkpO1xuICAgICAgfVxuICAgIH0sXG4gIH07XG59O1xuXG4kKHdpbmRvdykub24oXCJ3aGVlbFwiLCAoZSkgPT4ge1xuICBjb25zdCBkZWx0YVkgPSBlLm9yaWdpbmFsRXZlbnQuZGVsdGFZO1xuICBjb25zdCBzY3JvbGxlciA9IHZpZXdwb3J0U2Nyb2xsZXIoKTtcblxuICBpZiAoZGVsdGFZID4gMCkge1xuICAgIHNjcm9sbGVyLm5leHQoKTtcbiAgfVxuICBcbiAgaWYgKGRlbHRhWSA8IDAgKSB7XG4gICAgc2Nyb2xsZXIucHJldigpO1xuICB9XG4gfSk7XG5cbiAkKHdpbmRvdykub24oXCJrZXlkb3duXCIsIChlKSA9PiB7XG4gIGNvbnN0IHRhZ05hbWUgPSBlLnRhcmdldC50YWdOYW1lLnRvTG93ZXJDYXNlKCk7XG4gIGNvbnN0IHVzZXJUeXBpbmdJbklucHV0cyA9IHRhZ05hbWUgPT0gXCJpbnB1dFwiIHx8IHRhZ05hbWUgPT0gXCJ0ZXh0YXJlYVwiO1xuICBjb25zdCBzY3JvbGxlciA9IHZpZXdwb3J0U2Nyb2xsZXIoKTtcblxuICBpZiAodXNlclR5cGluZ0luSW5wdXRzKSByZXR1cm47XG5cbiAgc3dpdGNoIChlLmtleUNvZGUpIHtcbiAgICBjYXNlIDM4OlxuICAgICAgICBzY3JvbGxlci5wcmV2KCk7XG4gICAgICBicmVhaztcbiAgICAgIFxuICAgIGNhc2UgNDA6XG4gICAgICAgIHNjcm9sbGVyLm5leHQoKTtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuIH0pO1xuXG4gJChcIi53cmFwcGVyXCIpLm9uKFwidG91Y2htb3ZlXCIsIChlKSA9PiBlLnByZXZlbnREZWZhdWx0KCkpO1xuXG4gJChcIltkYXRhLXNjcm9sbC10b11cIikuY2xpY2soKGUpID0+IHtcbiAgIGUucHJldmVudERlZmF1bHQoKTtcblxuICBjb25zdCAkdGhpcyA9ICQoZS5jdXJyZW50VGFyZ2V0KTtcbiAgY29uc3QgdGFyZ2V0ID0gJHRoaXMuYXR0cihcImRhdGEtc2Nyb2xsLXRvXCIpO1xuICBjb25zdCByZXFTZWN0aW9uID0gJChgW2RhdGEtc2VjdGlvbi1pZD0ke3RhcmdldH1dYCk7XG4gIFxuICBwZXJmb3JtVHJhbnNpdGlvbihyZXFTZWN0aW9uLmluZGV4KCkpO1xuIH0pO1xuXG5pZiAoaXNNb2JpbGUpIHtcbiAgLy8gIGh0dHBzOi8vZ2l0aHViLmNvbS9tYXR0YnJ5c29uL1RvdWNoU3dpcGUtSnF1ZXJ5LVBsdWdpblxuICAkKFwiYm9keVwiKS5zd2lwZSh7XG4gICAgc3dpcGU6IGZ1bmN0aW9uIChldmVudCwgZGlyZWN0aW9uKSB7XG4gICAgICBjb25zdCBzY3JvbGxlciA9IHZpZXdwb3J0U2Nyb2xsZXIoKTtcbiAgICAgIGxldCBzY3JvbGxEaXJlY3Rpb24gPSBcIlwiO1xuXG4gICAgICBpZiAoZGlyZWN0aW9uID09IFwidXBcIikgc2Nyb2xsRGlyZWN0aW9uID0gXCJuZXh0XCI7XG4gICAgICBpZiAoZGlyZWN0aW9uID09IFwiZG93blwiKSBzY3JvbGxEaXJlY3Rpb24gPSBcInByZXZcIjtcblxuICAgICAgc2Nyb2xsZXJbc2Nyb2xsRGlyZWN0aW9uXSgpO1xuICAgIH0sXG4gIH0pO1xufSIsImNvbnN0IHNsaWRlciA9ICQoJy5zbGlkZXJzX19saXN0JykuYnhTbGlkZXIoe1xuICBwYWdlcjogZmFsc2UsXG4gIGNvbnRyb2xzOiBmYWxzZVxufSk7XG5cbiQoJy5zbGlkZXJzX19hcnJvdy0tbGVmdCcpLmNsaWNrKGUgPT4ge1xuICBlLnByZXZlbnREZWZhdWx0KCk7XG4gIHNsaWRlci5nb1RvUHJldlNsaWRlKCk7XG59KVxuJCgnLnNsaWRlcnNfX2Fycm93LS1yaWdodCcpLmNsaWNrKGUgPT4ge1xuICBlLnByZXZlbnREZWZhdWx0KCk7XG4gIHNsaWRlci5nb1RvTmV4dFNsaWRlKCk7XG59KSIsImNvbnN0IGZpbmRCbG9ja0J5QWxpYXMgPSBhbGlhcyA9PiB7XG4gIHJldHVybiAkKCcucmV2aWV3c19fY29udGVudCcpLmZpbHRlcigobmR4LCBpdGVtKSA9PiB7XG4gICAgcmV0dXJuICQoaXRlbSkuYXR0cihcImRhdGEtbGlua2VkLXdpdGhcIikgPT0gYWxpYXNcbiAgfSk7XG59O1xuXG4kKCcuaW50ZXJhY3RpdmUtYXZhdGFyX19saW5rJykuY2xpY2soZSA9PiB7XG4gIGUucHJldmVudERlZmF1bHQoKTtcblxuICBjb25zdCAkdGhpcyA9ICQoZS5jdXJyZW50VGFyZ2V0KTtcbiAgY29uc3QgdGFyZ2V0ID0gJHRoaXMuYXR0cihcImRhdGEtb3BlblwiKTtcbiAgY29uc3QgaXRlbVRvU2hvdyA9IGZpbmRCbG9ja0J5QWxpYXModGFyZ2V0KTtcbiAgY29uc3QgY3VySXRlbSA9ICR0aGlzLmNsb3Nlc3QoXCIuaW50ZXJhY3RpdmUtYXZhdGFyXCIpO1xuXG4gIGl0ZW1Ub1Nob3cuYWRkQ2xhc3MoXCJhY3RpdmVcIikuc2libGluZ3MoKS5yZW1vdmVDbGFzcyhcImFjdGl2ZVwiKTtcbiAgY3VySXRlbS5hZGRDbGFzcyhcImFjdGl2ZVwiKS5zaWJsaW5ncygpLnJlbW92ZUNsYXNzKFwiYWN0aXZlXCIpO1xufSkiLCJsZXQgdmlkZW87XG5sZXQgZHVyYXRpb25Db250cm9sO1xubGV0IHNvdW5kQ29udHJvbDtcbmxldCBpbnRlcnZhbElkO1xuXG5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgZT0+e1xuICAgIHZpZGVvID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3ZpZGVvJyk7XG5cbiAgICB2aWRlby5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHBsYXlTdG9wKTtcblxuICAgIGxldCBwbGF5QnV0dG9ucyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5wbGF5Jyk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwbGF5QnV0dG9ucy5sZW5ndGg7IGkrKykge1xuICAgICAgICBwbGF5QnV0dG9uc1tpXS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHBsYXlTdG9wKTtcbiAgICB9XG5cbiAgICBsZXQgbWljQ29udHJvbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtaWNMZXZlbCcpO1xuICAgIG1pY0NvbnRyb2wuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snICwgc291bmRPZik7XG5cbiAgICBkdXJhdGlvbkNvbnRyb2wgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZHVyYXRpb25MZXZlbCcpO1xuICAgIGR1cmF0aW9uQ29udHJvbC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nICwgc3RvcEludGVydmFsKTtcbiAgICBkdXJhdGlvbkNvbnRyb2wuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBzZXRWaWRlb0R1cmF0aW9uKTtcblxuICAgIGR1cmF0aW9uQ29udHJvbC5taW4gPSAwO1xuICAgIGR1cmF0aW9uQ29udHJvbC52YWx1ZSA9IDA7XG5cbiAgICBzb3VuZENvbnRyb2wgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndm9sdW1lTGV2ZWwnKTtcbiAgICBzb3VuZENvbnRyb2wuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snICwgY2hhbmdlU291bmRWb2x1bWUpO1xuICAgIHNvdW5kQ29udHJvbC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJyAsIGNoYW5nZVNvdW5kVm9sdW1lKTtcblxuICAgIHNvdW5kQ29udHJvbC5taW4gPSAwO1xuICAgIHNvdW5kQ29udHJvbC5tYXggPSAxMDtcblxuICAgIHNvdW5kQ29udHJvbC52YWx1ZSA9IHNvdW5kQ29udHJvbC5tYXg7XG5cbn0pXG5cbmZ1bmN0aW9uIHBsYXlTdG9wKCl7XG4gICAgbGV0IHBsYXlJbWcgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcudmlkZW9fX3BsYXknKTtcbiAgICBwbGF5SW1nLmNsYXNzTGlzdC50b2dnbGUoJ3ZpZGVvX19wbGF5LS1hY3RpdmUnKTtcblxuICAgIGR1cmF0aW9uQ29udHJvbC5tYXggPSB2aWRlby5kdXJhdGlvbjtcblxuICAgIGlmKHZpZGVvLnBhdXNlZCl7XG4gICAgICAgIHZpZGVvLnBsYXkoKTtcbiAgICAgICAgaW50ZXJ2YWxJZCA9IHNldEludGVydmFsKHVwZGF0ZUR1cmF0aW9uICwgMTAwMCAvNjYpO1xuICAgIH1lbHNleyBcbiAgICAgICAgdmlkZW8ucGF1c2UoKTtcbiAgICAgICAgY2xlYXJJbnRlcnZhbChpbnRlcnZhbElkKTtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIHVwZGF0ZUR1cmF0aW9uKCl7XG4gICAgZHVyYXRpb25Db250cm9sLnZhbHVlID0gdmlkZW8uY3VycmVudFRpbWU7XG59XG5cbmZ1bmN0aW9uIHN0b3BJbnRlcnZhbCgpe1xuICAgIHZpZGVvLnBhdXNlKCk7XG4gICAgY2xlYXJJbnRlcnZhbChpbnRlcnZhbElkKTtcbn1cblxuZnVuY3Rpb24gc2V0VmlkZW9EdXJhdGlvbigpe1xuICAgIGlmKHZpZGVvLnBhdXNlZCl7XG4gICAgICAgIHZpZGVvLnBsYXkoKTtcbiAgICB9ZWxzZXtcbiAgICAgICAgdmlkZW8ucGF1c2UoKTtcbiAgICB9XG5cbiAgICB2aWRlby5jdXJyZW50VGltZSA9IGR1cmF0aW9uQ29udHJvbC52YWx1ZTtcbiAgICBpbnRlcnZhbElkID0gc2V0SW50ZXJ2YWwodXBkYXRlRHVyYXRpb24gLCAxMDAwIC82Nik7XG59XG5cbmZ1bmN0aW9uIGNoYW5nZVNvdW5kVm9sdW1lKCl7XG4gICAgdmlkZW8udm9sdW1lID0gc291bmRDb250cm9sLnZhbHVlLzEwO1xufVxuXG5mdW5jdGlvbiBzb3VuZE9mKCl7XG4gICAgaWYodmlkZW8udm9sdW1lID09PSAwKXtcbiAgICAgICAgdmlkZW8udm9sdW1lID0gc291bmRMZXZlbDtcbiAgICAgICAgc291bmRDb250cm9sLnZhbHVlID0gc291bmRMZXZlbCAqIDEwO1xuICAgIH1lbHNle1xuICAgICAgICBzb3VuZExldmVsID0gdmlkZW8udm9sdW1lO1xuICAgICAgICB2aWRlby52b2x1bWUgPSAwO1xuICAgICAgICBzb3VuZENvbnRyb2wudmFsdWUgPSAwO1xuICAgIH1cbn1cbiJdfQ==
